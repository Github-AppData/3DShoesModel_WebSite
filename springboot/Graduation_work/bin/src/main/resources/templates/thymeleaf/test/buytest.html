<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>결제 및 환불 예제</title>
</head>
<body>
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <button onclick="requestPay()">결제하기</button>
  <button onclick="requestPay2()">카카오 결제하기</button>
  <button onclick="cancelPay()">환불하기</button>
  <button onclick="requestCert()">인증하기</button>

  <script>
    const userCode = "imp62443370";
    let payUid;
    
    IMP.init(userCode);

    function requestPay() {
      // 결제시 전달되는 정보
      IMP.request_pay({
      	pg: 'html5_inicis',
      	pay_method: 'card',
      	merchant_uid: 'merchant_' + new Date().getTime(),
      	name: '주문명:결제테스트',
      	amount: 10,
      	buyer_email: 'dlfheks@naver.com',
      	buyer_name: '테스터',
      	buyer_tel: '010-3061-3357',
      	buyer_addr: '서울특별시 강남구 삼성동',
      	buyer_postcode: '123-456'
      }, function(rsp) {
        var result = '';
        var msg = '';
        if (rsp.success) {
          msg = '결제가 완료되었습니다.\n';
          msg += '고유ID : ' + rsp.imp_uid + '\n';
          msg += '상점 거래ID : ' + rsp.merchant_uid + '\n';
          msg += '결제 금액 : ' + rsp.paid_amount;

          payUid = rsp.imp_uid;
        } else {
          msg += '에러내용 : ' + rsp.error_msg;
        }
        alert(msg);
      });
    }

    //카카오 결제
    function requestPay2() {
    
      IMP.request_pay({
        pg: "kakaopay",
        pay_method: "card",
        merchant_uid: 'merchant_' + new Date().getTime(),
        name: '주문명:결제테스트',
        amount: 10,
        buyer_name: '테스터',
        buyer_tel: "010-3061-3357",
      }, function(rsp) {
        var result = '';
        var msg = '';
        if (rsp.success) {
          msg = '결제가 완료되었습니다.\n';
          msg += '고유ID : ' + rsp.imp_uid + '\n';
          msg += '상점 거래ID : ' + rsp.merchant_uid + '\n';
          msg += '결제 금액 : ' + rsp.paid_amount;
        } else {
          msg += '에러내용 : ' + rsp.error_msg;
        }
        alert(msg);
      });
    }

    //환불 환불시 자체 프록시 서버로 에 있는 refund 를 POST로 실행하여 처리하고 결과를 가져옴 환불이 되면 success:true 반환
    function cancelPay() {
      if (!payUid) {
        alert("결제가 이루어지지 않았거나 환불할 내역이 없습니다.");
        return;
      }

      // 서버 엔드포인트 호출
      fetch('http://localhost:3000/refund', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json' //헤더
        },
        body: JSON.stringify({ impUid: payUid }) 
      })
      .then(response => response.json())
      .then(data => {
    	console.log(data);
        alert(data.message);
        // 환불이 성공하고 난뒤에 추가적인 페이지 이동이나 메시지 작성 부분 이긴한데 아직 모르겠다
      })
      .catch(error => {
        alert("환불 요청 중 오류가 발생했습니다.");
        
        console.error(error);
      });
    }
	//본인 인증 api 는 모든걸 알고 있다 빨리 말해 이사람이 맞는거같나
    function requestCert() {
      IMP.certification({
        pg: "inicis_unified",
        merchant_uid: 'merchant_' + new Date().getTime(),
        pay_method: "card",
        request_id: "req_1692798571850",
        tier_code: undefined,
      }, function(rsp) {
        var msg = '';
        if (rsp.success) {
          msg += '인증이 완료되었습니다.';
        } else {
          msg += '에러내용 : ' + rsp.error_msg;
        }
        alert(msg);
      });
    }
  </script>
</body>
</html>
